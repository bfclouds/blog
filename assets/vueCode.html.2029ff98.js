import{_ as n,o as s,c as a,a as t}from"./app.09528a02.js";const p={},e=t(`<h1 id="vue3\u6E90\u7801" tabindex="-1"><a class="header-anchor" href="#vue3\u6E90\u7801" aria-hidden="true">#</a> vue3\u6E90\u7801</h1><p>vue3\u6E90\u7801\u5B66\u4E60\u7B14\u8BB0</p><h2 id="\u67B6\u6784\u8BBE\u8BA1" tabindex="-1"><a class="header-anchor" href="#\u67B6\u6784\u8BBE\u8BA1" aria-hidden="true">#</a> \u67B6\u6784\u8BBE\u8BA1</h2><h2 id="\u54CD\u5E94\u7CFB\u7EDF" tabindex="-1"><a class="header-anchor" href="#\u54CD\u5E94\u7CFB\u7EDF" aria-hidden="true">#</a> \u54CD\u5E94\u7CFB\u7EDF</h2><h3 id="_1\u3001\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u57FA\u672C\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u57FA\u672C\u5B9E\u73B0" aria-hidden="true">#</a> 1\u3001\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u57FA\u672C\u5B9E\u73B0</h3><p>\u7B80\u6613\u7684\u54CD\u5E94\u5F0F\u5B9E\u4F8B\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;\u4ED8\u6587\u6C5F&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
  <span class="token literal-property property">other</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> proxyUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bucket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
    bucket<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// \u526F\u4F5C\u7528\u51FD\u6570</span>
<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;\u6211\u88AB\u6267\u884C\u4E86&quot;</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>proxyUser<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;xxx&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u5982\u4E0A\u4EE3\u7801\u4E2D\uFF0C\u901A\u8FC7proxy\u4EE3\u7406\u4E86user\u5BF9\u8C61\u7684get\u548Cset;\u5F53\u4FEE\u6539proxyUser\u7684name\u5C5E\u6027\u7684\u65F6\u5019\uFF0C\u9875\u9762\u4F1A\u968F\u4E4B\u66F4\u65B0</p><p>\u540D\u4E3Aeffect\u7684\u526F\u4F5C\u7528\u51FD\u6570\u5728set\u7684\u65F6\u5019\u88AB\u6267\u884C\uFF0C\u8FD9\u6BB5\u4EE3\u7801\u4E2D\uFF0C\u6211\u4EEC\u786C\u7F16\u7801\u4E86effect\u51FD\u6570\uFF0C\u5982\u679C\u526F\u4F5C\u7528\u51FD\u6570\u4E0D\u53EBeffect\uFF0C\u90A3\u4E48\u8FD9\u6BB5\u4EE3\u7801\u5C31\u62A5\u9519\u4E86\uFF1B\u4F46\u662F\u5B9E\u9645\u60C5\u51B5\u4E2D\uFF0C\u6211\u4EEC\u5E0C\u671B\u4E00\u4E2A\u7BAD\u5934\u51FD\u6570\uFF0C\u751A\u81F3\u533F\u540D\u51FD\u6570\u90FD\u662F\u53EF\u4EE5\u6267\u884C\u7684\uFF0C\u4E8E\u662F\u9700\u8981\u4E00\u4E2A\u6CE8\u518C\u526F\u4F5C\u7528\u51FD\u6570\u7684\u51FD\u6570\uFF1B</p><p>\u4FEE\u6539effect\u65B9\u6CD5\uFF0C\u5C06effect\u6539\u4E3A\u6CE8\u518C\u526F\u4F5C\u7528\u51FD\u6570\u7684\u65B9\u6CD5</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;\u4ED8\u6587\u6C5F&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
  <span class="token literal-property property">other</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> proxyUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span>
    bucket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
    bucket<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> fn
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;\u6211\u88AB\u6267\u884C\u4E86&quot;</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>proxyUser<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;xxx&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u4E2D\uFF0C\u6211\u4EEC\u5C01\u88C5\u4E86effect\u65B9\u6CD5\u53BB\u53BB\u6CE8\u518C\u526F\u4F5C\u7528\u51FD\u6570\uFF0C\u8FD9\u6BB5\u4EE3\u7801\u770B\u4F3C\u6CA1\u95EE\u9898\uFF0C\u5B9E\u9645\u4E0A\u8FD8\u662F\u6709\u95EE\u9898\u7684\uFF0C\u5F53\u4E3AproxyUser\u6DFB\u52A0\u4E00\u4E2A\u4E0D\u5B58\u5728\u7684\u5C5E\u6027\u65F6\uFF0C\u80FD\u770B\u5230\u9875\u9762\u88AB\u66F4\u65B0\u4E86\uFF0C\u8FD9\u663E\u7136\u4E0D\u662F\u6211\u4EEC\u60F3\u770B\u5230\u7684\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u53E6\u4E00\u79CD\u6570\u636E\u7ED3\u6784\u6765\u4FDD\u5B58\u539F\u6570\u636E\u3001key\u548C\u526F\u4F5C\u7528\u4E4B\u95F4\u7684\u5173\u7CFB\uFF1B</p><p>\u5206\u6790\u5982\u4E0B\u4EE3\u7801:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>
<span class="token keyword">function</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;\u6211\u88AB\u6267\u884C\u4E86&quot;</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>proxyUser<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u88AB\u8BFB\u53D6\u7684\u5BF9\u8C61\u662FproxyUser\uFF0C\u88AB\u8BFB\u53D6\u7684key\u662Fname\uFF0C\u89E6\u53D1\u7684\u526F\u4F5C\u7528\u662Feffect\uFF1B\u4E5F\u5C31\u662F\u4E0A\u8FF0\u6240\u8BF4\u7684\u539F\u6570\u636E\u3001key\u548Ceffect\u526F\u4F5C\u7528\uFF1B\u901A\u8FC7\u4E0A\u8FF0\u5206\u6790\u53EF\u5F97\u5982\u4E0B\u7ED3\u6784\uFF1B</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;\u4ED8\u6587\u6C5F&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> user2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;\u4ED8\u6587\u6C5F2&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// \u6570\u636E\u7ED3\u6784</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">[</span>effectFn1<span class="token punctuation">,</span> effectFn2<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">user2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">[</span>effectFn3<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9996\u5148user\u662F\u4E2Aobj\u5BF9\u8C61\uFF0C\u6240\u4EE5\u9700\u8981\u4E00\u4E2Akey\u53EF\u4EE5\u662F\u5BF9\u8C61\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u6B64\u65F6\u6EE1\u8DB3\u8981\u6C42\u7684\u662FMap\u548CWeakMap\uFF0C\u5982\u4E0A\u5B9E\u4F8B\u6211\u4EEC\u9700\u8981\u4FDD\u5B58user\u5BF9\u8C61\uFF0C\u4F46\u662F\u5982\u679C\u4F7F\u7528Map\u7684\u8BDD\uFF0C\u56E0\u4E3Auser\u88ABMap\u4F5C\u4E3Akey\u5F15\u7528\u4E86\uFF0C\u5BFC\u81F4\u5F53user\u5728\u5176\u5B83\u5730\u65B9\u5E76\u6CA1\u6709\u88AB\u5F15\u7528\u5230\u7684\u65F6\u5019\u4F9D\u7136\u5B58\u5728\u5185\u5B58\u4E2D\uFF0C\u4E0D\u88AB\u5783\u573E\u56DE\u6536\u673A\u5236\u56DE\u6536\uFF1B\u6240\u4EE5\u6211\u4EEC\u4F7F\u7528WeakMap\u5F31Map\uFF0C\u5728WeakMap\u4E2D\u4F5C\u4E3Akey\u88AB\u5F15\u7528\uFF0C\u5E76\u4E0D\u4F1A\u5F71\u54CD\u5783\u573E\u56DE\u6536\u673A\u5236\uFF1B</p><p>effectFn\u53EF\u80FD\u5177\u6709\u591A\u4E2A\uFF0C\u6240\u4EE5\u53EF\u4EE5\u5229\u7528Set\u6765\u5B58\u50A8</p><p>key\u548Ceffect\u7684\u5173\u7CFB\u662Fkey\u548Cvalue\u7684\u5173\u7CFB\uFF0C\u6211\u4EEC\u4F7F\u7528Map\u6765\u5B58\u50A8\uFF0C\u4FEE\u6539\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;\u4ED8\u6587\u6C5F&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">other</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> proxyUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
    
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// \u6CE8\u518C\u526F\u4F5C\u7528</span>
<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> fn
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// \u8FD9\u91CC\u6267\u884C\u7684\u76EE\u7684\u662F\u4E3A\u4E86\u8C03\u7528\u51FD\u6570\u91CC\u7684proxyUser.name\u89E6\u53D1get\uFF0C\u6536\u96C6\u4F9D\u8D56</span>
<span class="token punctuation">}</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>proxyUser<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;\u4ED8\u6587\u6C5F123&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>xxk1 <span class="token operator">=</span> <span class="token string">&quot;\u4ED8\u6587\u6C5F123xx&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6\u8BBE\u7F6E proxyUser.xxk1\u7684\u65F6\u5019\u5C06\u4E0D\u4F1A\u89E6\u53D1\u526F\u4F5C\u7528\u51FD\u6570\u7684\u6267\u884C\uFF0C\u6700\u540E\u5C01\u88C5\u4E00\u4E0B\uFF0C\u5C06get\u4E2D\u5B58\u50A8\u526F\u4F5C\u7528\u51FD\u6570\u7684\u90E8\u5206\u5C01\u88C5\u5728track\uFF08\u8FFD\u8E2A\uFF09\u4E2D\uFF0C\u5C06set\u4E2D\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570\u7684\u90E8\u5206\u5C01\u88C5\u5728trigger\uFF08\u89E6\u53D1\uFF09\u4E2D\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">strack</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> proxyUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">strack</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2\u3001\u5206\u652F\u5207\u6362" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u5206\u652F\u5207\u6362" aria-hidden="true">#</a> 2\u3001\u5206\u652F\u5207\u6362</h3><p>\u73B0\u5728\u6709\u5982\u4E0B\u4EE3\u7801\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">isShowName</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;\u4ED8\u6587\u6C5F&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// ... \u7701\u7565userProxy\u90E8\u5206\u4EE3\u7801</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeEffect <span class="token operator">=</span> fn
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u6211\u88AB\u6267\u884C\u4E86!&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> val <span class="token operator">=</span> proxyUser<span class="token punctuation">.</span>flag <span class="token operator">?</span> proxyUser<span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token string">&quot;\u9635\u96E8\u6765\u88AD&quot;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;\u798F\u798F\u798F&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxyUser<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728effect\u4E2D\uFF0C\u5F53flag\u4E3Atrue\u7684\u65F6\u5019\uFF0Cval\u7684\u503C\u662Fname\uFF0C\u5F53flag\u4E3Afalse\u7684\u65F6\u5019\uFF0Cval\u7684\u503C\u662F\u201C\u9635\u96E8\u6765\u88AD\u201D\uFF0C\u8FD9\u79CD\u56E0\u4E3Aflag\u53D8\u5316\u800C\u4EA7\u751F\u7684\u53D8\u5316\u5C31\u79F0\u4E3A\u5206\u652F\u5207\u6362\uFF1B</p><p>\u5F53flag\u7684\u503C\u4E3Afalse\u7684\u65F6\u5019\uFF0C\u6B64\u65F6ui\u663E\u793A\u7684\u662F&quot;\u9635\u96E8\u6765\u88AD&quot;\uFF0C\u800C\u540E\u6211\u4EEC\u4FEE\u6539\u4E86name\uFF0C\u56E0\u4E3Aflag\u4E3Afalse\uFF0C\u6240\u4EE5val\u7684\u503C\u4F9D\u7136\u662F\u201C\u9635\u96E8\u6765\u88AD\u201D\uFF0C\u6240\u4EE5ui\u663E\u793A\u201C\u9635\u96E8\u6765\u88AD\u201D\uFF0C\u540E\u9762\u6211\u4EEC\u4FEE\u6539flag\u7684\u503C\u4E3Atrue\uFF0C\u56E0\u6B64val\u4E3Aname\uFF0Cui\u663E\u793Aname\u7684\u503C\uFF1B</p><p>name\u7684\u8FD9\u6B21\u4FEE\u6539\u56E0\u4E3Afalg\u4E3Afalse\uFF0C\u6240\u4EE5val\u7684\u503C\u5B9E\u9645\u4E0A\u5E76\u6CA1\u6709\u53D8\u5316\uFF0C\u4F46\u662F\u526F\u4F5C\u7528\u51FD\u6570\u88AB\u6267\u884C\u4E86\uFF0C\u6240\u4EE5\u8FD9\u6B21\u526F\u4F5C\u7528\u51FD\u6570\u7684\u6267\u884C\u5B9E\u9645\u4E0A\u662F\u6CA1\u6709\u5FC5\u8981\u7684\uFF0C\u6216\u8005\u8BF4\u5B83\u7684\u8FD9\u6B21\u6267\u884C\u662F\u5728\u6D6A\u8D39\u8D44\u6E90\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u526F\u4F5C\u7528\u5B58\u5728\u4E8Ename\u4E2D\u5C31\u662F\u9519\u8BEF\u7684\uFF0C\u53EF\u4EE5\u8BF4\u8FD9\u4E2A\u526F\u4F5C\u7528\u8FD9\u662F\u4E0A\u6B21\u4F9D\u8D56\u6536\u96C6\u7684\u6B8B\u7559\u526F\u4F5C\u7528\uFF0C\u6211\u4EEC\u672C\u5E94\u8BE5\u628A\u5B83\u6E05\u7406\u6389\uFF1B</p><p>\u56E0\u6B64\u6211\u4EEC\u9700\u8981\u5C06effectFn\u548C\u4EE3\u7406\u7684key\u7684\u526F\u4F5C\u7528\u51FD\u6570\u5217\u8868\uFF08Set\uFF09\u76F8\u4E92\u5173\u8054\u8D77\u6765\uFF0C\u8FD9\u6837\u5C31\u80FD\u77E5\u9053\u526F\u4F5C\u7528\u51FD\u6570\u88AB\u8C01\u6536\u96C6\u4E86\uFF0C\u624D\u80FD\u505A\u6E05\u7406\u7684\u64CD\u4F5C\uFF1B\u4E8E\u662F\u505A\u5982\u4E0B\u4FEE\u6539:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token comment">// \u65B0\u589E</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u4FEE\u6539</span>
  <span class="token keyword">function</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    activeEffect <span class="token operator">=</span> fn
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u6211\u88AB\u6267\u884C\u4E86!&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> val <span class="token operator">=</span> proxyUser<span class="token punctuation">.</span>flag <span class="token operator">?</span> proxyUser<span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token string">&quot;\u9635\u96E8\u6765\u88AD&quot;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728effect\u4E2D\uFF0C\u6211\u4EEC\u7ED9effectFn\u52A0\u4E0Adeps\uFF08deps\u662F\u7528\u6765\u5B58\u50A8\u8FD9\u4E2A\u526F\u4F5C\u7528\u5728\u54EA\u4E9B\u54CD\u5E94\u5F0F\u6570\u636E\u7684\u4F9D\u8D56\u96C6\u5408\u4E2D\uFF09\uFF0C\u6B64\u65F6deps\u4E3A\u7A7A\uFF1B\u5728track\u4E2DeffectFn\u88AB\u6DFB\u52A0\u5230\u4E86Set\u4E2D\uFF0C\u4F5C\u4E3A\u4E86\u5BF9\u5E94key\u7684\u526F\u4F5C\u7528\u51FD\u6570\uFF0C\u90A3\u4E48\u6B64\u65F6\u6211\u4EEC\u5C06Set\u6DFB\u52A0\u5230effectFn\u7684deps\u4E2D\uFF0C\u8FD9\u6837\u5C31\u5B9E\u73B0\u4E86effectFn\u548C\u88AB\u4EE3\u7406key\u6536\u96C6\u7684\u4F9D\u8D56\u4E4B\u95F4\u7684\u5173\u8054\uFF08\u6B64\u65F6\u4EE3\u7406key\u7684Set\u4E2D\u6709effectFn\uFF0CeffectFn\u7684deps\u4E2D\u6709Set\uFF09\uFF1B</p><p>\u63A5\u4E0B\u6765\u9700\u8981\u5728effectFn\u6267\u884C\u7684\u65F6\u5019\u6E05\u9664\u6389Set\u4E2D\u7684effectFn</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cleanEffect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span> <span class="token comment">// \u65B0\u589E</span>
    activeEffect <span class="token operator">=</span> fn
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cleanEffect</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> deps <span class="token operator">=</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    deps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6837\u5C31\u5B9E\u73B0\u4E86\u5728effectFn\u6267\u884C\u7684\u65F6\u5019\u5148\u6E05\u9664\u6389\u4E86\u6240\u6709\u5305\u542BeffectFn\u7684Set\u4E2D\u7684effectFn\uFF0C\u7136\u540E\u518D\u91CD\u65B0\u505A\u4F9D\u8D56\u6536\u96C6\uFF0C\u90A3\u4E48\u5C31\u4E0D\u4F1A\u6709\u6B8B\u7559\u7684\u526F\u4F5C\u7528\u51FD\u6570\u4E86\uFF0C\u6B64\u65F6\u6267\u884C\u4EE3\u7801\uFF0C\u5F53falg\u4E3Afalse\u540E\uFF0C\u518D\u6539\u53D8name\u5C06\u4E0D\u4F1A\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570\uFF1B</p><h3 id="\u6267\u884C\u8C03\u5EA6" tabindex="-1"><a class="header-anchor" href="#\u6267\u884C\u8C03\u5EA6" aria-hidden="true">#</a> \u6267\u884C\u8C03\u5EA6</h3><h3 id="_4\u3001watch" tabindex="-1"><a class="header-anchor" href="#_4\u3001watch" aria-hidden="true">#</a> 4\u3001watch</h3><h3 id="_5\u3001computed" tabindex="-1"><a class="header-anchor" href="#_5\u3001computed" aria-hidden="true">#</a> 5\u3001computed</h3><h2 id="\u6E32\u67D3\u5668" tabindex="-1"><a class="header-anchor" href="#\u6E32\u67D3\u5668" aria-hidden="true">#</a> \u6E32\u67D3\u5668</h2><h3 id="\u6302\u8F7D\u4E0E\u66F4\u65B0" tabindex="-1"><a class="header-anchor" href="#\u6302\u8F7D\u4E0E\u66F4\u65B0" aria-hidden="true">#</a> \u6302\u8F7D\u4E0E\u66F4\u65B0</h3><h3 id="\u7B80\u5355diff\u7B97\u6CD5" tabindex="-1"><a class="header-anchor" href="#\u7B80\u5355diff\u7B97\u6CD5" aria-hidden="true">#</a> \u7B80\u5355diff\u7B97\u6CD5</h3><h3 id="\u53CC\u7AEFdiff\u7B97\u6CD5" tabindex="-1"><a class="header-anchor" href="#\u53CC\u7AEFdiff\u7B97\u6CD5" aria-hidden="true">#</a> \u53CC\u7AEFdiff\u7B97\u6CD5</h3><h3 id="\u5FEB\u901Fdiff\u7B97\u6CD5" tabindex="-1"><a class="header-anchor" href="#\u5FEB\u901Fdiff\u7B97\u6CD5" aria-hidden="true">#</a> \u5FEB\u901Fdiff\u7B97\u6CD5</h3><h2 id="\u7EC4\u4EF6\u5316" tabindex="-1"><a class="header-anchor" href="#\u7EC4\u4EF6\u5316" aria-hidden="true">#</a> \u7EC4\u4EF6\u5316</h2><h3 id="\u7EC4\u4EF6\u5B9E\u73B0\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#\u7EC4\u4EF6\u5B9E\u73B0\u539F\u7406" aria-hidden="true">#</a> \u7EC4\u4EF6\u5B9E\u73B0\u539F\u7406</h3><h3 id="\u5F02\u6B65\u7EC4\u4EF6\u5DE5\u4F5C\u673A\u5236\u548C\u5B9E\u73B0\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#\u5F02\u6B65\u7EC4\u4EF6\u5DE5\u4F5C\u673A\u5236\u548C\u5B9E\u73B0\u539F\u7406" aria-hidden="true">#</a> \u5F02\u6B65\u7EC4\u4EF6\u5DE5\u4F5C\u673A\u5236\u548C\u5B9E\u73B0\u539F\u7406</h3><h3 id="\u51FD\u6570\u5F0F\u7EC4\u4EF6\u5DE5\u4F5C\u673A\u5236\u548C\u5B9E\u73B0\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570\u5F0F\u7EC4\u4EF6\u5DE5\u4F5C\u673A\u5236\u548C\u5B9E\u73B0\u539F\u7406" aria-hidden="true">#</a> \u51FD\u6570\u5F0F\u7EC4\u4EF6\u5DE5\u4F5C\u673A\u5236\u548C\u5B9E\u73B0\u539F\u7406</h3><h2 id="\u7F16\u8BD1\u5668" tabindex="-1"><a class="header-anchor" href="#\u7F16\u8BD1\u5668" aria-hidden="true">#</a> \u7F16\u8BD1\u5668</h2><h3 id="\u6A21\u677F\u7F16\u8BD1" tabindex="-1"><a class="header-anchor" href="#\u6A21\u677F\u7F16\u8BD1" aria-hidden="true">#</a> \u6A21\u677F\u7F16\u8BD1</h3><h3 id="\u6A21\u677F\u7F16\u8BD1\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#\u6A21\u677F\u7F16\u8BD1\u4F18\u5316" aria-hidden="true">#</a> \u6A21\u677F\u7F16\u8BD1\u4F18\u5316</h3><h2 id="\u670D\u52A1\u7AEF\u6E32\u67D3" tabindex="-1"><a class="header-anchor" href="#\u670D\u52A1\u7AEF\u6E32\u67D3" aria-hidden="true">#</a> \u670D\u52A1\u7AEF\u6E32\u67D3</h2><h3 id="vue\u540C\u6784\u6E32\u67D3\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#vue\u540C\u6784\u6E32\u67D3\u539F\u7406" aria-hidden="true">#</a> vue\u540C\u6784\u6E32\u67D3\u539F\u7406</h3><p>\u540C\u6784\u6E32\u67D3\u7B80\u5355\u6765\u8BF4\u5C31\u662F\u4E00\u4EFD\u4EE3\u7801\uFF0C\u670D\u52A1\u7AEF\u5148\u901A\u8FC7\u670D\u52A1\u7AEF\u6E32\u67D3(server-side rendering)\uFF0C\u751F\u6210html\u4EE5\u53CA\u521D\u59CB\u5316\u6570\u636E\uFF0C\u5BA2\u6237\u7AEF\u62FF\u5230\u4EE3\u7801\u548C\u521D\u59CB\u5316\u6570\u636E\u540E\uFF0C\u901A\u8FC7\u5BF9html\u7684dom\u8FDB\u884Cpatch\u548C\u4E8B\u4EF6\u7ED1\u5B9A\u5BF9dom\u8FDB\u884C\u5BA2\u6237\u7AEF\u6FC0\u6D3B(client-side hydration)\uFF0C\u8FD9\u4E2A\u6574\u4F53\u7684\u8FC7\u7A0B\u53EB\u540C\u6784\u6E32\u67D3\u3002</p>`,52),o=[e];function c(i,l){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","vueCode.html.vue"]]);export{r as default};
